<!DOCTYPE html>

<html>
<head>
  <title>Client.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Client.html">
                Client.coffee
              </a>
            
              
              <a class="source" href="ClientContainer.html">
                ClientContainer.coffee
              </a>
            
              
              <a class="source" href="ClientModel.html">
                ClientModel.coffee
              </a>
            
              
              <a class="source" href="ClientStore.html">
                ClientStore.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="RequestHandler.html">
                RequestHandler.coffee
              </a>
            
              
              <a class="source" href="Server.html">
                Server.coffee
              </a>
            
              
              <a class="source" href="ServerContainer.html">
                ServerContainer.coffee
              </a>
            
              
              <a class="source" href="ServerStore.html">
                ServerStore.coffee
              </a>
            
              
              <a class="source" href="SocketHandler.html">
                SocketHandler.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="parseAcceptHeader.html">
                parseAcceptHeader.coffee
              </a>
            
              
              <a class="source" href="Mediator.html">
                Mediator.coffee
              </a>
            
              
              <a class="source" href="Message.html">
                Message.coffee
              </a>
            
              
              <a class="source" href="PageMap.html">
                PageMap.coffee
              </a>
            
              
              <a class="source" href="Strings.html">
                Strings.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Client.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="npm-dependencies">NPM dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://github.com/jquery/jquery">jquery</a><br><a href="https://github.com/stephenhandley/type-of-is">type-of-is</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>)
Type = <span class="hljs-built_in">require</span>(<span class="hljs-string">'type-of-is'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="local-dependencies">Local dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><a href="./ClientContainer.html">ClientContainer</a><br><a href="./ClientStore.html">ClientStore</a><br><a href="../Shared/Mediator.html">Mediator</a><br><a href="../Shared/Message.html">Message</a><br><a href="../Shared/PageMap.html">PageMap</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Container = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ClientContainer'</span>)
Store     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ClientStore'</span>)
Mediator  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/Mediator'</span>)
Message   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/Message'</span>)
PageMap   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/PageMap'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This is set to true once the constructor has been called</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>constructed = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1 id="client">Client</h1>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>An instance of Client serves as the entry point for all code run 
in the user’s browser. It handles sending and receiving data 
to and from the server, manages navigation, history and page
transitions. The Client uses <a href="../Mediator.html">Mediator</a> for
pubsub-style message broadcast between itself and the views.</p>
<p>In its constructor, the client opens a WebSocket connection to 
the server. After this connection is successfully opened, the 
client sends an <strong>initialize</strong> message to the server, and then
waits for 2 things to happen</p>
<ol>
<li><strong>domready</strong> event fires in browser</li>
<li><strong>initializeReply</strong> message arrives from server</li>
</ol>
<p>After those both happen then the <strong>_run</strong> method takes care of syncing
the current page with the dom. The page’s views then handle user 
interaction and use the client’s <strong>send</strong> method (via the <a href="./Mediator.html">Mediator</a>) 
to send data to and from the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Configuration for client reconnecting when WebSocket loses connectivity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reconnect : {
    working     : <span class="hljs-literal">false</span>
    attempts    : <span class="hljs-number">0</span>
    max_timeout : <span class="hljs-number">5000</span>
    min_timeout : <span class="hljs-number">1000</span>
    disabled    : <span class="hljs-literal">false</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>auth is of the form
{
  token   : <jwt token>
  expires : <optional token expiration time>
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  __auth : <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>true after domready event fired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _dom_ready : <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>true when the socket is open</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _socket_open : <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="constructor">constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3 id="required-args">required args</h3>
<p><strong>map</strong> : map of routes to pages  </p>
<h3 id="optional-args">optional args</h3>
<p><strong>models</strong>    : Client side models.. if present, client will traverse the
                message data and inflate plain json objects into instances
                of those models using the $model attr </p>
<p><strong>reconnect</strong> : If false, disables autoreconnect, otherwise should
                be object that can specify the following configuration
                params: <em>max_timeout</em>, <em>min_timeout</em>  </p>
<p><strong>container</strong> : Override the default container used for pages. Default
                implementation is <a href="./Container.html">Container</a>
                If overriding, you must set container on server as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>make sure this constructor cannot be called a second time 
on clientside e.g. from browser console </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> constructed
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Client already constructed"</span>)
    <span class="hljs-keyword">else</span>
      constructed = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> [<span class="hljs-string">'name'</span>, <span class="hljs-string">'map'</span>]      
      <span class="hljs-keyword">unless</span> (k <span class="hljs-keyword">of</span> args)
        error = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Client missing required argument: <span class="hljs-subst">#{k}</span>"</span>)
        <span class="hljs-keyword">throw</span> error

    <span class="hljs-property">@_name</span> = args.name</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>can override default store when creating client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    store = <span class="hljs-keyword">if</span> (<span class="hljs-string">'store'</span> <span class="hljs-keyword">of</span> args)
      args.store
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">new</span> Store()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>can override the default container when creating client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_container</span> = <span class="hljs-keyword">if</span> (<span class="hljs-string">'container'</span> <span class="hljs-keyword">of</span> args)
      args.container
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">new</span> Container(
        map   : args.map
        store : store
      )</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>models are instances of <a href="./ClientModel.html">ClientModel</a>
if passed, they’ll be used to inflate message data recieved 
over socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">'models'</span> <span class="hljs-keyword">of</span> args)
      Message.setModels(args.models)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>reconnect arg can be object or false. If its an object, set 
the associated key value pairs, if its false disable reconnect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">'reconnect'</span> <span class="hljs-keyword">of</span> args)
      <span class="hljs-keyword">if</span> (args.reconnect <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span>)
        <span class="hljs-property">@_reconnect</span>.disabled = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> args.reconnect
          <span class="hljs-property">@_reconnect</span>[k] = v</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><a href="../Mediator.html">Mediator</a> provides decoupled pubsub-style
communication between client components. We</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Mediator.delegate(
      <span class="hljs-string">'send'</span> : @
      <span class="hljs-string">'goto'</span> : <span class="hljs-property">@_container</span>
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><a href="http://caniuse.com/websockets">http://caniuse.com/websockets</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-string">'WebSocket'</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">window</span>)
      <span class="hljs-property">@_connect</span>()
    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>TODO: better handling of this .. optional fall back to $.ajax? </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@_clientError</span>(<span class="hljs-string">"WebSockets not supported by browser"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>After document is ready set flag, emit event, and then 
init the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $<span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">document</span>)</span>.<span class="hljs-title">ready</span>(<span class="hljs-params">()</span>=&gt;</span>
      <span class="hljs-property">@_dom_ready</span> = <span class="hljs-literal">true</span>
      Mediator.emit(<span class="hljs-string">'client:domready'</span>)
      <span class="hljs-property">@_init</span>()
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="logout">logout</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  logout : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_auth</span>(<span class="hljs-literal">null</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="_clienterror-">_clientError </h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _clientError : <span class="hljs-function"><span class="hljs-params">(message)</span>-&gt;</span>
    error = <span class="hljs-keyword">new</span> Error(message)
    Mediator.emit(<span class="hljs-string">'client:error'</span>, error)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="_init">_init</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>This method only runs through its full body after two conditions
have been met  </p>
<ol>
<li>domready event has fired in browser</li>
<li>socket has opened</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _init : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@_dom_ready</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@_socket_open</span>
      <span class="hljs-keyword">return</span>

    page_key = <span class="hljs-property">@_container</span>.pageKey()
    <span class="hljs-property">@send</span>(
      name : <span class="hljs-string">'initialize'</span>
      data : {
        page_key : page_key
      }
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="_run">_run</h2>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The initializeReply contains two pieces of data that the client 
needs: initial_data used to render the page on the server, and an
id_map of views that make up the page. The client looks up the name 
of the page via the “data-page” body attribute, and then instantiates
the page of that name with initial_data and id_map. The page syncs 
with the dom and handles user interaction, delegating to Mediator.send
to relay messages to/from the server via this client’s send method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _run : <span class="hljs-function"><span class="hljs-params">(init_data)</span>=&gt;</span>
    error = <span class="hljs-property">@_container</span>.sync(init_data)

    <span class="hljs-keyword">if</span> error
      <span class="hljs-property">@_clientError</span>(error)
    <span class="hljs-keyword">else</span>
      Mediator.emit(<span class="hljs-string">'client:ready'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="_auth">_auth</h2>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Accessor for auth object. If passed one argument it will 
set the auth var and check expiration. If auth is null or 
expired it will remove it. If not, it will write it to 
localStorage
If passed no argument it will read from localStorage (if 
neccessary) and check expiration. If unexpired will 
return the auth object, otherwise null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _auth : <span class="hljs-function"><span class="hljs-params">(auth)</span>-&gt;</span>
    key = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-property">@_name</span>}</span>:auth"</span>
<span class="hljs-function">
    <span class="hljs-title">removeAuth</span> = <span class="hljs-params">()</span>=&gt;</span>
      localStorage.removeItem(key)
      <span class="hljs-property">@__auth</span> = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>check auth expiration, remove auth from local storage
if expired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">checkAuthExpiration</span> = <span class="hljs-params">()</span>=&gt;</span>
      <span class="hljs-keyword">unless</span> <span class="hljs-property">@__auth</span>
        <span class="hljs-keyword">return</span>

      expired = (<span class="hljs-property">@__auth</span>.expires <span class="hljs-keyword">and</span> (<span class="hljs-property">@__auth</span>.expires &lt; Date.now()))
      <span class="hljs-keyword">if</span> expired
        removeAuth()

    <span class="hljs-keyword">if</span> (arguments.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>)
      <span class="hljs-keyword">if</span> auth</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>its a write</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-property">@__auth</span> = auth
        checkAuthExpiration()

        <span class="hljs-keyword">if</span> <span class="hljs-property">@__auth</span>
          raw_auth = JSON.stringify(<span class="hljs-property">@__auth</span>)
          localStorage.setItem(key, raw_auth)
      
      <span class="hljs-keyword">else</span>
        removeAuth()

    <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>its a read</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">unless</span> <span class="hljs-property">@__auth</span>
        raw_auth = localStorage.getItem(key)
        <span class="hljs-keyword">if</span> raw_auth
          <span class="hljs-property">@__auth</span> = JSON.parse(raw_auth)

      checkAuthExpiration()

      <span class="hljs-property">@__auth</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="websocket-methods">WebSocket Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h2 id="send">send</h2>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>send a message to the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">send</span>: <span class="hljs-function"><span class="hljs-params">(message)</span> =&gt;</span>
    <span class="hljs-keyword">unless</span> Type(message, Message)
      message = <span class="hljs-keyword">new</span> Message(message)

    auth = <span class="hljs-property">@_auth</span>()
    message.token = <span class="hljs-keyword">if</span> auth <span class="hljs-keyword">then</span> auth.token <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    
    raw_message = message.stringify()
    Mediator.emit(<span class="hljs-string">'client:send'</span>, raw_message)
    <span class="hljs-property">@_socket</span>.send(raw_message)</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h2 id="_connect">_connect</h2>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>called to connect to server when the Client is 
initially constructed and called to reconnect 
after the client loses connectivity </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _connect : <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
    socket_url = <span class="hljs-string">"ws://<span class="hljs-subst">#{<span class="hljs-built_in">window</span>.location.host}</span>"</span>
    <span class="hljs-property">@_socket</span> = <span class="hljs-keyword">new</span> WebSocket(socket_url)
    
    <span class="hljs-property">@_socket</span>.onopen    = <span class="hljs-property">@_onOpen</span>
    <span class="hljs-property">@_socket</span>.onmessage = <span class="hljs-property">@_onMessage</span>
    <span class="hljs-property">@_socket</span>.onclose   = <span class="hljs-property">@_onClose</span>
    <span class="hljs-property">@_socket</span>.onerror   = <span class="hljs-property">@_onError</span>

    event = <span class="hljs-keyword">if</span> <span class="hljs-property">@_reconnect</span>.working
      <span class="hljs-string">'reconnecting'</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-string">'connecting'</span>

    Mediator.emit(<span class="hljs-string">"client:<span class="hljs-subst">#{event}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h2 id="_onopen">_onOpen</h2>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>callback for when the socket is opened </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _onOpen : <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
    event = <span class="hljs-keyword">if</span> <span class="hljs-property">@_reconnect</span>.working
      <span class="hljs-property">@_reconnect</span>.attempts = <span class="hljs-number">0</span>
      <span class="hljs-property">@_reconnect</span>.working = <span class="hljs-literal">false</span>
      <span class="hljs-string">'reconnected'</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@_socket_open</span> = <span class="hljs-literal">true</span>
      <span class="hljs-property">@_init</span>()
      <span class="hljs-string">'connected'</span>
    
    Mediator.emit(<span class="hljs-string">'client:open'</span>)
    Mediator.emit(<span class="hljs-string">"client:<span class="hljs-subst">#{event}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h2 id="_onmessage">_onMessage</h2>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>callback for when a message is received</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _onMessage : <span class="hljs-function"><span class="hljs-params">(event)</span>=&gt;</span>
    raw_message = event.data
    Mediator.emit(<span class="hljs-string">'client:receive'</span>, raw_message)

    message = Message.parse(raw_message)

    <span class="hljs-keyword">if</span> message.<span class="hljs-keyword">in</span>([<span class="hljs-string">'initializeReply'</span>, <span class="hljs-string">'authenticateReply'</span>])
      @[<span class="hljs-string">"_<span class="hljs-subst">#{message.name}</span>"</span>](message)

    message_event         = <span class="hljs-string">'message'</span>
    message_event_name    = <span class="hljs-string">"<span class="hljs-subst">#{message_event}</span>:<span class="hljs-subst">#{message.name}</span>"</span>
    message_event_name_id = <span class="hljs-string">"<span class="hljs-subst">#{message_event_name}</span>:id:<span class="hljs-subst">#{message.id}</span>"</span>

    Mediator.emit(message_event, message)
    Mediator.emit(message_event_name, message)
    Mediator.emit(message_event_name_id, message)</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="_initializereply">_initializeReply</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _initializeReply : <span class="hljs-function"><span class="hljs-params">(message)</span>-&gt;</span>
    <span class="hljs-property">@_run</span>(message.data)</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h2 id="_authenticatereply">_authenticateReply</h2>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _authenticateReply : <span class="hljs-function"><span class="hljs-params">(message)</span>-&gt;</span>
    data = message.data
    Mediator.emit(<span class="hljs-string">"client:authenticated"</span>, data)
    <span class="hljs-keyword">delete</span> data.user
    <span class="hljs-property">@_auth</span>(data)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="_onerror">_onError</h2>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _onError : <span class="hljs-function"><span class="hljs-params">(error)</span>=&gt;</span>
    <span class="hljs-built_in">console</span>.error(error)
    <span class="hljs-property">@_clientError</span>(<span class="hljs-string">"Socket error"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <h2 id="_onclose">_onClose</h2>

            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Callback for when client’s socket connection to the
server closes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _onClose : <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
    Mediator.emit(<span class="hljs-string">'client:close'</span>)

    <span class="hljs-keyword">unless</span> <span class="hljs-property">@_reconnect</span>.disabled
      delay = <span class="hljs-property">@_reconnectDelay</span>()
      <span class="hljs-property">@_reconnect</span>.attempts += <span class="hljs-number">1</span>
      setTimeout(<span class="hljs-property">@_connect</span>, delay)</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="_reconnectdelay">_reconnectDelay</h2>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Calculate delay time before reconnect using exponential backoff 
algorithm so that reconnection attempts by different users are 
spread out in time rather than all at once</p>
<p><a href="http://dthain.blogspot.com/2009/02/exponential-backoff-in-distributed.html">http://dthain.blogspot.com/2009/02/exponential-backoff-in-distributed.html</a></p>
<p>delay = MIN( R <em> T </em> F ^ N , M )</p>
<p>R should be a random number in the range [1-2], so that its 
  effect is to spread out the load over time, but always more 
  conservative than plain backoff.</p>
<p>T is the initial timeout, and should be set at the outer limits of 
  expected response time for the service. For example, if your 
  service responds in 1ms on average but in 10ms for 99% of requests, 
  then set t=10ms.</p>
<p>F doesn’t matter much, so choose 2 as a nice round number. 
  (It’s the exponential nature that counts.)</p>
<p>M should be as low as possible to keep your customers happy, 
  but high enough that the system can definitely handle requests 
  from all clients at that sustained rate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reconnectDelay : <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
    spread       = Math.random() + <span class="hljs-number">1</span>
    min_timeout  = <span class="hljs-property">@_reconnect</span>.min_timeout
    base         = <span class="hljs-number">2</span>
    max_timeout  = <span class="hljs-property">@_reconnect</span>.max_timeout
    attempts     = <span class="hljs-property">@_reconnect</span>.attempts

    timeout = spread * min_timeout * Math.pow(base, attempts)
    Math.min(timeout, max_timeout)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Set the Mediator on the Client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Client.Mediator = Mediator

<span class="hljs-built_in">module</span>.exports = Client</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

<!DOCTYPE html>

<html>
<head>
  <title>ServerContainer.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Client.html">
                Client.coffee
              </a>
            
              
              <a class="source" href="ClientContainer.html">
                ClientContainer.coffee
              </a>
            
              
              <a class="source" href="ClientModel.html">
                ClientModel.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="JWT.html">
                JWT.coffee
              </a>
            
              
              <a class="source" href="RequestHandler.html">
                RequestHandler.coffee
              </a>
            
              
              <a class="source" href="Server.html">
                Server.coffee
              </a>
            
              
              <a class="source" href="ServerContainer.html">
                ServerContainer.coffee
              </a>
            
              
              <a class="source" href="SocketHandler.html">
                SocketHandler.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="parseAcceptHeader.html">
                parseAcceptHeader.coffee
              </a>
            
              
              <a class="source" href="Cache.html">
                Cache.coffee
              </a>
            
              
              <a class="source" href="Mediator.html">
                Mediator.coffee
              </a>
            
              
              <a class="source" href="Message.html">
                Message.coffee
              </a>
            
              
              <a class="source" href="PageMap.html">
                PageMap.coffee
              </a>
            
              
              <a class="source" href="Strings.html">
                Strings.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ServerContainer.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="npm-dependencies">NPM dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://github.com/stephenhandley/tf">tf</a><br><a href="https://github.com/stephenhandley/type-of-is">type-of-is</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Tag  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tf'</span>)
Type = <span class="hljs-built_in">require</span>(<span class="hljs-string">'type-of-is'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="local-dependencies">Local dependencies</h2>
<p><a href="./Strings.html">Strings</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Strings = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/Strings'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1 id="servercontainer">ServerContainer</h1>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The container provides all the HTML needed outside of the body tag. 
as well as </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerContainer</span></span>
  _status : <span class="hljs-number">200</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="constructor">constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>site_name</strong> : the name of the site serving this container</p>
<p><strong>logo_url</strong> : url for site logo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span>
    <span class="hljs-property">@_site_name</span> = args.site_name
    <span class="hljs-property">@_logo_url</span>  = args.logo_url</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="_idmap">_idMap</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Called on the server to build a map of all the view ids for 
the client to use for sync. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _idMap : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>    
<span class="hljs-function">    <span class="hljs-title">idMap</span> = <span class="hljs-params">(view)</span>-&gt;</span>
      map = {}
      <span class="hljs-keyword">for</span> id, subview <span class="hljs-keyword">of</span> view.subviews()
        map[subview.id] = idMap(subview)
      map

    idMap(<span class="hljs-property">@_page</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="load">load</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Load and build the page that this container is rendering</p>
<p><strong>page</strong> : page to load &amp; build</p>
<p><strong>callback</strong> : callback to return (error)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  load : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span>
    <span class="hljs-property">@_page</span>   = args.page
    callback = args.callback

    <span class="hljs-keyword">if</span> <span class="hljs-property">@_page</span>.needsUser()
      <span class="hljs-property">@_page</span>.setData({})
      <span class="hljs-property">@_page</span>.setBodyToLoadingView()
      callback(<span class="hljs-literal">null</span>)

    <span class="hljs-keyword">else</span>    
      <span class="hljs-property">@_page</span>.load(<span class="hljs-function"><span class="hljs-params">(error, data)</span>=&gt;</span>
        <span class="hljs-keyword">unless</span> error
          <span class="hljs-property">@_page</span>.setData(data)
          <span class="hljs-property">@_page</span>.buildAndSetBody()

        callback(error)
      )</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="initdata">initData</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Returns the page and id map data for this container to be
used in sync on the client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initData : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    result = {}
    result[Strings.ID_MAP]    = <span class="hljs-property">@_idMap</span>()
    result[Strings.PAGE_DATA] = <span class="hljs-property">@_page</span>.page_data
    result</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="status">status</h2>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>returns the http status</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  status : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_status</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="headers">headers</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>returns and custom headers for the container’s page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  headers : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_page</span>.headers()</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="html">html</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>render this container as html</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  html : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO</p>
<link rel="shortcut icon" href="#{@favicon_url}" />

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-string">"""
      &lt;!DOCTYPE html&gt;
      &lt;html&gt;
        &lt;head&gt;
          <span class="hljs-subst">#{<span class="hljs-property">@_meta</span>()}</span>

          &lt;title&gt;<span class="hljs-subst">#{<span class="hljs-property">@_title</span>()}</span>&lt;/title&gt;

          <span class="hljs-subst">#{(Tag.stylesheet(href: href) <span class="hljs-keyword">for</span> href <span class="hljs-keyword">in</span> <span class="hljs-property">@_page</span>.styles).join(<span class="hljs-string">"\n"</span>)}</span>
          
          <span class="hljs-subst">#{(Tag.script(src: src) <span class="hljs-keyword">for</span> src <span class="hljs-keyword">in</span> <span class="hljs-property">@_page</span>.scripts).join(<span class="hljs-string">"\n"</span>)}</span>
          
          <span class="hljs-subst">#{<span class="hljs-property">@_page</span>.head()}</span>        
        &lt;/head&gt;
        
        &lt;body <span class="hljs-subst">#{<span class="hljs-property">@_pageIdAttr</span>()}</span> <span class="hljs-subst">#{<span class="hljs-property">@_pageKeyAttr</span>()}</span> <span class="hljs-subst">#{<span class="hljs-property">@_isLoadingAttr</span>()}</span>&gt;
          <span class="hljs-subst">#{<span class="hljs-property">@_page</span>.html()}</span>
        &lt;/body&gt;
      &lt;/html&gt;
    """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="text">text</h2>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>render this container as text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  text : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_page</span>.text()</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="json">json</h2>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>render this container as json</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  json : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_page</span>.json()</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h2 id="-internal-methods-"><em>INTERNAL METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="_meta">_meta</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>pages should have a attribute or function ‘meta’ that provides 
the following metadata
{
  title       : <title for page>
  description : <description of page>
  image       : <image for page> (optional)
  type        : <type for page>  (optional)
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _meta : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    meta  = <span class="hljs-property">@_page</span>.getMeta()

    url   = <span class="hljs-property">@_page</span>.url
    title = <span class="hljs-property">@_title</span>()
    image = meta.image || <span class="hljs-property">@_logo_url</span>
    type  = meta.type || <span class="hljs-string">'website'</span>

    metadata = {
      name : {
        description : meta.description
        viewport    : <span class="hljs-property">@_page</span>.viewport || <span class="hljs-string">'width=device-width, initial-scale=1'</span>
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Google rich snippets
<a href="https://support.google.com/webmasters/answer/146750?hl=en">https://support.google.com/webmasters/answer/146750?hl=en</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      itemprop : {
        name        : title
        description : meta.description
        image       : image
        url         : url
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>FB Open Graph 
<a href="http://ogp.me">http://ogp.me</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      property : {
        <span class="hljs-string">"og:title"</span>       : title
        <span class="hljs-string">"og:description"</span> : meta.description
        <span class="hljs-string">"og:image"</span>       : image
        <span class="hljs-string">"og:url"</span>         : url
        <span class="hljs-string">"og:type"</span>        : type
        <span class="hljs-string">"og:site_name"</span>   : <span class="hljs-property">@_site_name</span>
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>additional open graph properties specific to og:type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> meta.og
      <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> meta.og
        metadata.property[<span class="hljs-string">"og:<span class="hljs-subst">#{k}</span>"</span>] = v</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>TODO: support html microdata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
    html = Tag.meta(charset : <span class="hljs-string">'utf-8'</span>) + <span class="hljs-string">"\n"</span>

    <span class="hljs-keyword">for</span> attr, m <span class="hljs-keyword">of</span> metadata
      <span class="hljs-keyword">for</span> name, content <span class="hljs-keyword">of</span> m
        args = { 
          content : content
        }
        args[attr] = name
        html += Tag.meta(args) + <span class="hljs-string">"\n"</span>
      
    html</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="_title">_title</h2>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Title for this container’s page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _title : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@_page</span>.title() || <span class="hljs-property">@_site_name</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="_pagekeyattr">_pageKeyAttr</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>The attribute used to pass this page’s id and name in 
the rendered html for use in client sync</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _pageKeyAttr : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-string">"<span class="hljs-subst">#{Strings.PAGE_KEY_ATTR_NAME}</span>=\"<span class="hljs-subst">#{<span class="hljs-property">@_page</span>.key()}</span>\""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="_pageidattr">_pageIdAttr</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Body attribute holding the page name (useful for CSS namespacing)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _pageIdAttr : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-string">"id=\"<span class="hljs-subst">#{<span class="hljs-property">@_page</span>.constructor.name}</span>\""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h2 id="_isloadingattr">_isLoadingAttr</h2>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Used by the client to determine whether the server was
able to render the full page or whether its loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _isLoadingAttr : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-string">"data-<span class="hljs-subst">#{Strings.IS_LOADING}</span>=\"<span class="hljs-subst">#{<span class="hljs-property">@_page</span>.needsUser()}</span>\""</span>

<span class="hljs-built_in">module</span>.exports = ServerContainer</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

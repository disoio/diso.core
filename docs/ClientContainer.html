<!DOCTYPE html>

<html>
<head>
  <title>ClientContainer.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Client.html">
                Client.coffee
              </a>
            
              
              <a class="source" href="ClientContainer.html">
                ClientContainer.coffee
              </a>
            
              
              <a class="source" href="ClientModel.html">
                ClientModel.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="RequestHandler.html">
                RequestHandler.coffee
              </a>
            
              
              <a class="source" href="Server.html">
                Server.coffee
              </a>
            
              
              <a class="source" href="ServerContainer.html">
                ServerContainer.coffee
              </a>
            
              
              <a class="source" href="SocketHandler.html">
                SocketHandler.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="parseAcceptHeader.html">
                parseAcceptHeader.coffee
              </a>
            
              
              <a class="source" href="Cache.html">
                Cache.coffee
              </a>
            
              
              <a class="source" href="Mediator.html">
                Mediator.coffee
              </a>
            
              
              <a class="source" href="Message.html">
                Message.coffee
              </a>
            
              
              <a class="source" href="PageMap.html">
                PageMap.coffee
              </a>
            
              
              <a class="source" href="Strings.html">
                Strings.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ClientContainer.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="npm-dependencies">NPM dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://github.com/jquery/jquery">jquery</a><br><a href="https://github.com/disoio/diso.router">diso.router</a>    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>$      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>)
Router = <span class="hljs-built_in">require</span>(<span class="hljs-string">'diso.router'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="local-dependencies">Local dependencies</h2>
<p><a href="./Mediator.html">Mediator</a><br><a href="./PageMap.html">PageMap</a><br><a href="./Strings.html">Strings</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Mediator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/Mediator'</span>)
PageMap  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/PageMap'</span>)
Strings  = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../Shared/Strings'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h1 id="clientcontainer">ClientContainer</h1>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Used by the client to sync the initial serverside render
with the clientside page, perform navigation between and 
within pages via HTML5 history api</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientContainer</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><a href="./PageMap.html">PageMap</a> is used for routing / page lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_page_map</span> = <span class="hljs-keyword">new</span> PageMap(args)
    <span class="hljs-property">@_initializeHistory</span>()

  pageKey : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    $(<span class="hljs-string">'body'</span>).attr(Strings.PAGE_ATTR_NAME)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="sync">sync</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This method use the data sent in the initializeReply message to 
create a page and sync it with the server-rendered html that is 
in the current dom. </p>
<p>A page is created using the body attribute of its constructor name
and passed the page_data from initializeReply. The id_map in that 
same message is then used to traverse the dom of and attach the 
view objects created in the client to their associated containers,
and update their ids to match those sent in the id_map (which are 
the ids that are present in the dom)</p>
<p><strong>init_data</strong> : the initial data received from initializeReply. This 
                should have two attributes: ‘id_map’ and ‘page_data’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sync : <span class="hljs-function"><span class="hljs-params">(init_data)</span>-&gt;</span>
    id_map    = init_data[Strings.ID_MAP]
    page_data = init_data[Strings.PAGE_DATA]

    [page_name, page_id] = <span class="hljs-property">@pageKey</span>().split(<span class="hljs-string">':'</span>)

    <span class="hljs-keyword">unless</span> page_name
      error = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"HTML body is missing <span class="hljs-subst">#{Strings.PAGE_ATTR_NAME}</span> attribute"</span>)
      <span class="hljs-keyword">return</span> error</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>use the page map to retrieve the page by this name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_page</span> = <span class="hljs-property">@_page_map</span>.sync(
      name      : page_name
      location  : <span class="hljs-built_in">window</span>.location
      data      : page_data
      container : @
    )

    <span class="hljs-keyword">unless</span> <span class="hljs-property">@_page</span>
      error = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"No page named <span class="hljs-subst">#{page_name}</span>"</span>)
      <span class="hljs-keyword">return</span> error</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>used to traverse the view hierarchy and sync each 
element of the view with id_map passed via the initalizeReply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">_syncView</span> = <span class="hljs-params">(args)</span>-&gt;</span>
      id   = args.id
      map  = args.map
      view = args.view

      view.setId(id)

      subids      = Object.keys(map)
      subviews    = view.subviews()
      temp_subids = Object.keys(subviews)

      <span class="hljs-keyword">if</span> (subids.length != temp_subids.length)
        error = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"Sync failed: Mismatch between map and view"</span>)
        <span class="hljs-keyword">throw</span> error

      <span class="hljs-keyword">if</span> (subids.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>recurse on subviews</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0</span> .. (subids.length - <span class="hljs-number">1</span>)]
        subid  = subids[i]
        submap = map[subid]

        temp_subid = temp_subids[i]
        subview    = subviews[temp_subid]
        
        _syncView(
          id   : subid
          map  : submap
          view : subview
        )</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>have the page build its views</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_page</span>.build()</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>sync the page (it will take care of syncing its subviews)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _syncView(
      id   : page_id
      map  : id_map
      view : <span class="hljs-property">@_page</span>
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>run the page (i.e. call setup on each view)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_page</span>.run()

  changePage : <span class="hljs-function"><span class="hljs-params">(new_page)</span>-&gt;</span>
    <span class="hljs-property">@_page</span>.remove()
    <span class="hljs-property">@_page</span> = new_page
    
    $body = $(<span class="hljs-string">'body'</span>)
    $body.html(<span class="hljs-property">@_page</span>.html())
    $body.attr(Strings.PAGE_ATTR_NAME, <span class="hljs-property">@_page</span>.key())

    <span class="hljs-property">@_page</span>.run()
    <span class="hljs-property">@_pushHistory</span>(new_page.route.path()) <span class="hljs-comment"># or just new_page.url ? </span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="goto">goto</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Make a transition between pages</p>
<p><strong>route</strong> : the route for new page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  goto : <span class="hljs-function"><span class="hljs-params">(args)</span>=&gt;</span>
    route = args.route
<span class="hljs-function">
    <span class="hljs-title">clientError</span> = <span class="hljs-params">(error)</span>-&gt;</span>
      Mediator.emit(<span class="hljs-string">'client:error'</span>, error)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>get a new page for this route from the page map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    new_page = <span class="hljs-property">@_page_map</span>.route(
      route     : route
      location  : <span class="hljs-built_in">window</span>.location
      container : @
    )

    <span class="hljs-keyword">unless</span> new_page
      error = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"No page for <span class="hljs-subst">#{route.name}</span>"</span>)
      <span class="hljs-keyword">return</span> clientError(error)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>TODO: make this way more robust
      for starters pass the JWT-token via get param or header</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">unless</span> <span class="hljs-property">@_supportsHistory</span>()
      <span class="hljs-built_in">window</span>.location = new_page.route.path()
      <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>load the new page </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    new_page.load(<span class="hljs-function"><span class="hljs-params">(error, data)</span>=&gt;</span>
      <span class="hljs-keyword">if</span> error
        <span class="hljs-keyword">return</span> clientError(error)

      new_page.setData(data)
      new_page.build()

      <span class="hljs-property">@changePage</span>(new_page)
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="-history-methods-"><em>HISTORY METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="_initializehistory">_initializeHistory</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Initialize the html5 history api. Using the browser api rather 
than adapter and falling back to full page loads if it isn’t 
support
<a href="http://diveintohtml5.info/history.html">http://diveintohtml5.info/history.html</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initializeHistory : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_supportsHistory</span>()
      $(<span class="hljs-built_in">window</span>).<span class="hljs-literal">on</span>(<span class="hljs-string">'popstate'</span>, <span class="hljs-property">@_onPopState</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="_supportshistory">_supportsHistory</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>returns true if the user’s browser supports HTML5 history
<a href="http://caniuse.com/#search=history">http://caniuse.com/#search=history</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _supportsHistory : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    !!(<span class="hljs-built_in">window</span>.history?.pushState)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="_onpopstate">_onPopState</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>called when user presses back button<br>TODO: handle this correctly / integrate with router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _onPopState : <span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"HANDLE POP STATE YO:"</span> + <span class="hljs-built_in">document</span>.location)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="_pushhistory">_pushHistory</h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>add url to the history. this will change the location bar to url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _pushHistory : <span class="hljs-function"><span class="hljs-params">(url)</span>-&gt;</span>
    <span class="hljs-built_in">window</span>.history.pushState(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, url)

<span class="hljs-built_in">module</span>.exports = ClientContainer</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
